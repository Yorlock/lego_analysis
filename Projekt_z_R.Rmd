---
title: "Projekt_z_R"
author: "Dominik Łukasiewicz"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: yes
    toc_float: true
    number_sections: yes
  word_document: default
  pdf_document: default
---

# Wstęp
Celem projektu jest analiza bazy danych Lego na przestrzeni lat.

# Przygotowanie środowiska
## Wykorzystane biblioteki

```{r, message=F, echo=F, warning=F}

library(knitr)
library(dplyr)
library(DT)
library(png)
library(skimr)
library(plotly)
library(ggplot2)
library(gridExtra)
library(caret)

prettyTable <- function(table_df, round_digits=2) {
    DT::datatable(table_df, style="bootstrap", filter = "top", rownames = FALSE, extensions = "Buttons", options = list(dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>% formatRound(names(dplyr::select_if(table_df, is.numeric)), round_digits)
}

opts_chunk$set(echo=F, message = F, warning = F)
```

- knitr - tworzenie raportów w R
- dplyr - przetwarzanie danych
- DT - wyświetlanie interaktywnych tabel
- png - wczytywanie i pokazywanie zdjęć
- skimr - tworzenie podsumowania danych
- ggplot2 - tworzenie wykresów
- plotly - tworzenie interaktywnych wykresów
- gridExtra - grupowanie wykresów
- caret - uczenie maszynowe

## Ustawienie powtarzalność wyników
W celu zapewnienia powtarzalności wyników ziarno zostało ustawione na 23.

```{r, echo=T}
set.seed(23)
```

```{r, cache=T}
unzip("data.zip")
```

# Schemat danych
```{r, cache=T, echo=T}
rebrickable_schema <- readPNG("data/rebrickable_schema_v3.png")
grid::grid.raster(rebrickable_schema)
```

# Wstępne przetwarzanie danych
## Wczytanie danych
```{r, cache=T, echo=T}
colors_raw <- read.csv("data/colors.csv", header = T, sep = ",")
elements_raw <- read.csv("data/elements.csv", header = T, sep = ",")
inventories_raw <- read.csv("data/inventories.csv", header = T, sep = ",")
inventory_minifigs_raw <- read.csv("data/inventory_minifigs.csv", header = T, sep = ",")
inventory_parts_raw <- read.csv("data/inventory_parts.csv", header = T, sep = ",")
inventory_sets_raw <- read.csv("data/inventory_sets.csv", header = T, sep = ",")
minifigs_raw <- read.csv("data/minifigs.csv", header = T, sep = ",")
part_categories_raw <- read.csv("data/part_categories.csv", header = T, sep = ",")
part_relationships_raw <- read.csv("data/part_relationships.csv", header = T, sep = ",")
parts_raw <- read.csv("data/parts.csv", header = T, sep = ",")
sets_raw <- read.csv("data/sets.csv", header = T, sep = ",")
themes_raw <- read.csv("data/themes.csv", header = T, sep = ",")
```
## Przetwarzanie brakujących danych
### Colors
Brak modyfikacji surowych danych
```{r, echo=T}
colors_clean <- colors_raw
```
### Elements
Usunięcie nadmiarowej kolumny design_id, która nie miała wykorzystania w schemacie 
```{r, echo=T}
elements_clean <- elements_raw[, -4]
```
### Inventories
Brak modyfikacji surowych danych
```{r, echo=T}
inventories_clean <- inventories_raw
```
### Inventory Minifigs
Brak modyfikacji surowych danych
```{r, echo=T}
inventory_minifigs_clean <- inventory_minifigs_raw
```
### Inventory Parts
Usunięcie nadmiarowej kolumny img_url, która nie podlega analizie
```{r, echo=T}
inventory_parts_clean <- inventory_parts_raw[, -6]
```
### Inventory Sets
Brak modyfikacji surowych danych
```{r, echo=T}
inventory_sets_clean <- inventory_sets_raw
```
### Minifigs
Usunięcie nadmiarowej kolumny img_url, która nie podlega analizie
```{r, echo=T}
minifigs_clean <- minifigs_raw[, -4]
```
### Part Categories
Brak modyfikacji surowych danych
```{r, echo=T}
part_categories_clean <- part_categories_raw
```
### Part Relationships
Brak modyfikacji surowych danych
```{r, echo=T}
part_relationships_clean <- part_relationships_raw
```
### Parts
Brak modyfikacji surowych danych
```{r, echo=T}
parts_clean <- parts_raw
```
### Sets
Usunięcie nadmiarowej kolumny img_url, która nie podlega analizie
```{r, echo=T}
sets_clean <- sets_raw[, -6]
```
### Themes
Brak modyfikacji surowych danych
```{r, echo=T}
themes_clean <- themes_raw
```
## Podstawowe statystyki
### Colors
```{r, echo=T}
knitr::kable((head(colors_clean)))
skim(colors_clean)
```
### Elements
```{r, echo=T}
knitr::kable((head(elements_clean)))
skim(elements_clean)
```
### Inventories
```{r, echo=T}
knitr::kable((head(inventories_clean)))
skim(inventories_clean)
```
### Inventory Minifigs
```{r, echo=T}
knitr::kable((head(inventory_minifigs_clean)))
skim(inventory_minifigs_clean)
```
### Inventory Parts
```{r, echo=T}
knitr::kable((head(inventory_parts_clean)))
skim(inventory_parts_clean)
```
### Inventory Sets
```{r, echo=T}
knitr::kable((head(inventory_sets_clean)))
skim(inventory_sets_clean)
```
### Minifigs
```{r, echo=T}
knitr::kable((head(minifigs_clean)))
skim(minifigs_clean)
```
### Part Categories
```{r, echo=T}
knitr::kable((head(part_categories_clean)))
skim(part_categories_clean)
```
### Part Relationships
```{r, echo=T}
knitr::kable((head(part_relationships_clean)))
skim(part_relationships_clean)
```
### Parts
```{r, echo=T}
knitr::kable((head(parts_clean)))
skim(parts_clean)
```
### Sets
```{r, echo=T}
knitr::kable((head(sets_clean)))
skim(sets_clean)
```
### Themes
```{r, echo=T}
knitr::kable((head(themes_clean)))
skim(themes_clean)
```
# Analiza danych

```{r}
top_colors <- 10
```

## Analiza wykorzystanych kolorów w elementach
Poniższy wykres ukazuje `r top_colors` najczęściej używanych kolorów w elementach.
Zgodnie z uzyskanym wynikiem, najczęściej używanymi kolorami są: czarny, biały, czerwony.
Warte również uwagi jest fakt, iż za brak koloru uważa się kolor czarny.

```{r, echo=F}
elements_with_colors_df <- left_join(elements_clean, colors_clean, by = join_by(color_id == id))

sum_most_used_colors_df <- data.frame(table(elements_with_colors_df$name))

colnames(sum_most_used_colors_df) <- c("Color", "Quantity")

sum_most_used_colors_df <- sum_most_used_colors_df %>%
  arrange(desc(Quantity)) %>%
  head(top_colors)

sorted_colors_with_rgb <-left_join(sum_most_used_colors_df, colors_clean, by = join_by(Color == name)) %>%
  arrange(desc(Quantity))

rgb_names_list <- sorted_colors_with_rgb %>%
  select(rgb) %>%
  c() %>%
  lapply(function(x) paste0("#", x))

color_names_list <- sorted_colors_with_rgb %>%
  select(Color) %>%
  c()

rgb_color_pairs <- setNames(rgb_names_list$rgb, color_names_list$Color)

most_used_colors_plot <- ggplot(sum_most_used_colors_df, aes(x = reorder(Color, Quantity), y = Quantity, fill = Color, color = "black")) +
  geom_bar(stat = "identity", position = "identity") +
  labs(title = "Najczęściej używany kolor w elementach", x = "Color", y = "Quantity") +
  scale_fill_manual(values=rgb_color_pairs) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none")

ggplotly(most_used_colors_plot, tooltip = c("Color", "Quantity"))

```

```{r}
top_minifigs <- 10
```
## Analiza najczęściej używanych minifigach w zestawach
Poniższe wykresy ukazuje `r top_minifigs` najczęściej używanych minifigów w zestawach.
Pierwszy wykres agreguje dane po nazwach, natomiast drugi po unikalnych indeksach.
Analizując uzyskane wyniki możemy dostrzeć, że wyniki różnią się.
Wynika to z faktu, iż istnieją minifigi posiadające taką samą nazwę, ale różniącą się indeksem.
Takie minifigi różnią się najczęściej barwą kolorów, ilością zastosowanych elementów lub materiałem z których zostały wykonane.
```{r, echo=F}
minifigs_with_inventory_df <- left_join(minifigs_clean, inventory_minifigs_clean, by = join_by(fig_num == fig_num))

sum_most_used_minifigs_by_name_df <- minifigs_with_inventory_df %>%
  select(fig_num, name, quantity) %>%
  group_by(name) %>%
  summarise(sum_of_quantity = sum(quantity)) %>%
  arrange(desc(sum_of_quantity)) %>%
  head(top_minifigs)

colnames(sum_most_used_minifigs_by_name_df) <- c("Minifig", "Quantity")

sum_most_used_minifigs_by_fig_df <- minifigs_with_inventory_df %>%
  select(fig_num, name, quantity) %>%
  group_by(fig_num, name) %>%
  summarise(sum_of_quantity = sum(quantity)) %>%
  arrange(desc(sum_of_quantity)) %>%
  head(top_minifigs)

colnames(sum_most_used_minifigs_by_fig_df) <- c("Fig_num", "Minifig", "Quantity")

most_used_minifig_by_name_plot <- ggplot(sum_most_used_minifigs_by_name_df, aes(x = reorder(Minifig, Quantity), y = Quantity, fill = Minifig, color = "black")) +
  geom_bar(stat = "identity", position = "identity") +
  labs(title = "Najczęściej używane minifigi w \nzestawach agregując po nazwach", x = "Minifig", y = "Quantity") +
  coord_flip() +
  scale_fill_brewer(palette="Set3") +
  theme_minimal() +
  theme(legend.position = "none")

most_used_minifig_by_fig_plot <- ggplot(sum_most_used_minifigs_by_fig_df, aes(x = reorder(Minifig, Quantity), y = Quantity, fill = Minifig, color = "black")) +
  geom_bar(stat = "identity", position = "identity") +
  labs(title = "Najczęściej używane minifigi w \nzestawach agregując po indeksach", x = "Minifig", y = "Quantity") +
  coord_flip() +
  scale_fill_brewer(palette="Set3") +
  theme_minimal() +
  theme(legend.position = "none")

ggplotly(most_used_minifig_by_name_plot, tooltip = c("Minifig", "Quantity"))
ggplotly(most_used_minifig_by_fig_plot, tooltip = c("Minifig", "Quantity"))
```